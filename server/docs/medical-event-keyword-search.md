# Medical Event System - Keyword Search & Privacy Security

## üìã T·ªïng quan
H·ªá th·ªëng s·ª± ki·ªán y t·∫ø ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a ƒë·ªÉ h·ªó tr·ª£ keyword search n√¢ng cao v√† ƒë·∫£m b·∫£o b·∫£o m·∫≠t th√¥ng tin nh·∫°y c·∫£m.

## üîç C√°ch th·ª©c ho·∫°t ƒë·ªông

### 1. Keyword Search cho Medical Events
Khi search medical events v·ªõi keyword, h·ªá th·ªëng s·∫Ω t√¨m ki·∫øm trong c√°c fields:

- **studentInfo.name** - T√™n h·ªçc sinh
- **studentInfo.studentCode** - M√£ s·ªë h·ªçc sinh
- **description** - M√¥ t·∫£ s·ª± ki·ªán y t·∫ø
- **note** - Ghi ch√∫
- **solution** - Gi·∫£i ph√°p x·ª≠ l√Ω

### 2. Smart Query Strategy
```typescript
// N·∫øu c√≥ keyword -> s·ª≠ d·ª•ng aggregation pipeline
if (queryBuilder.keyword && queryBuilder.keyword.trim().length > 0) {
  return this.getAllMedicalEventsWithAggregation(queryBuilder);
}

// N·∫øu kh√¥ng c√≥ keyword -> s·ª≠ d·ª•ng simple filter (nhanh h∆°n)
return this.getAllMedicalEventsBasic(queryBuilder);
```

## üîß Aggregation Pipeline Implementation

### 1. Pipeline Structure
```typescript
const pipeline = [  // Step 1: Apply base filters FIRST (type, level, status, dateHappened)
  { $match: baseFilter },
  
  // Step 2: Unwind studentJoin array
  { $unwind: '$studentJoin' },
  
  // Step 3: Lookup student information
  {
    $lookup: {
      from: 'children',
      localField: 'studentJoin.studentId',
      foreignField: '_id',
      as: 'studentInfo'
    }
  },
    // Step 4: Unwind student info
  { $unwind: '$studentInfo' },
  
  // Step 5: Apply keyword search
  {
    $match: {
      $or: [
        { 'studentInfo.name': { $regex: keyword, $options: 'i' } },
        { 'studentInfo.studentCode': { $regex: keyword, $options: 'i' } },
        { 'description': { $regex: keyword, $options: 'i' } },
        { 'note': { $regex: keyword, $options: 'i' } },
        { 'solution': { $regex: keyword, $options: 'i' } }
      ]
    }
  },
  
  // Step 6: Group back to recreate original structure
  {
    $group: {
      _id: '$_id',
      // ... all fields
    }
  },
  
  // Step 7: Populate user & student with selected fields only
  // ... lookup operations
  
  // Step 8: Sort and paginate
  { $sort: query.getSort() }
];
```

## üîê Privacy & Security Features

### 1. Hidden Sensitive Fields
C√°c field nh·∫°y c·∫£m ƒë√£ ƒë∆∞·ª£c ·∫©n trong t·∫•t c·∫£ API responses:

**User Information:**
- ‚úÖ Tr·∫£ v·ªÅ: `_id`, `name`, `email`, `isActive`
- ‚ùå ·∫®n: `password`, `refreshToken`, `role` (n·∫øu c√≥)

**Student Information:**
- ‚úÖ Tr·∫£ v·ªÅ: `_id`, `name`, `studentCode`, `medicalConverageId`
- ‚ùå ·∫®n: C√°c th√¥ng tin c√° nh√¢n kh√°c

### 2. Secure Populate Implementation
```typescript
// Trong aggregation pipeline
{
  $lookup: {
    from: 'users',
    localField: 'userId',
    foreignField: '_id',
    as: 'userId',
    pipeline: [
      {
        $project: {
          _id: 1,
          name: 1,
          email: 1,
          isActive: 1
        }
      }
    ]
  }
}

// Trong basic queries
.populate({
  path: "userId",
  select: "name email _id isActive"
})
.populate({
  path: "studentJoin.studentId",
  select: "name studentCode medicalConverageId"
})
```

## üåê API Endpoints ƒë∆∞·ª£c c·∫≠p nh·∫≠t

### 1. GET /medical-events
**Parameters:**
- `keyword` - T√¨m ki·∫øm theo t√™n/m√£ h·ªçc sinh, description, note, solution
- `type` - Lo·∫°i s·ª± ki·ªán y t·∫ø
- `level` - M·ª©c ƒë·ªô nghi√™m tr·ªçng
- `status` - Tr·∫°ng th√°i
- `startDate` - T·ª´ ng√†y
- `endDate` - ƒê·∫øn ng√†y
- `page` - Trang hi·ªán t·∫°i
- `limit` - S·ªë records tr√™n m·ªói trang

**Example Requests:**
```bash
# Search theo t√™n h·ªçc sinh
GET /medical-events?keyword=Nguyen Van A

# Search theo m√£ h·ªçc sinh
GET /medical-events?keyword=HS001

# Search theo description
GET /medical-events?keyword=s·ªët cao

# Combined filters
GET /medical-events?keyword=ho&type=illness&level=medium&page=1&limit=10
```

### 2. Affected Methods
C√°c ph∆∞∆°ng th·ª©c ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ ·∫©n th√¥ng tin nh·∫°y c·∫£m:

- `getAllMedicalEvents()` - C√≥ keyword search & privacy
- `getAllMedicalEventsBasic()` - Ch·ªâ c√≥ privacy
- `getMedicalEventById()` - Ch·ªâ c√≥ privacy  
- `updateMedicalEvent()` - Ch·ªâ c√≥ privacy
- `searchMedicalEvents()` - Ch·ªâ c√≥ privacy
- `getMedicalEventsByStudentId()` - C·∫ßn c·∫≠p nh·∫≠t th√™m privacy

## ‚ö° Performance Considerations

### 1. Indexing Recommendations
```javascript
// T·∫°o indexes cho performance t·ªët h∆°n
db.medicalevents.createIndex({ "type": 1 });
db.medicalevents.createIndex({ "level": 1 });
db.medicalevents.createIndex({ "status": 1 });
db.medicalevents.createIndex({ "dateHappened": 1 });

// Text search indexes
db.medicalevents.createIndex({ 
  "description": "text", 
  "note": "text", 
  "solution": "text" 
});

// Student collection indexes
db.children.createIndex({ "name": "text", "studentCode": "text" });
```

### 2. Pagination v·ªõi Aggregation
- S·ª≠ d·ª•ng `$skip` v√† `$limit` trong pipeline
- Count total records v·ªõi pipeline ri√™ng bi·ªát
- Tr·∫£ v·ªÅ ƒë√∫ng format pagination chu·∫©n

### 3. Memory Usage
- Aggregation pipeline c√≥ th·ªÉ s·ª≠ d·ª•ng nhi·ªÅu memory h∆°n
- C√¢n nh·∫Øc s·ª≠ d·ª•ng `allowDiskUse: true` cho datasets l·ªõn
- Monitor performance v·ªõi datasets th·ª±c t·∫ø

## üß™ Testing

### 1. Test Cases c·∫ßn ki·ªÉm tra
```bash
# 1. Keyword search functionality
curl "http://localhost:3000/medical-events?keyword=Nguyen"

# 2. Privacy - ki·ªÉm tra kh√¥ng c√≥ password trong response
curl "http://localhost:3000/medical-events" | grep -i password

# 3. Combined filters
curl "http://localhost:3000/medical-events?keyword=s·ªët&type=illness"

# 4. Pagination
curl "http://localhost:3000/medical-events?keyword=test&page=2&limit=5"

# 5. Empty keyword (should use basic query)
curl "http://localhost:3000/medical-events?keyword="
```

### 2. Performance Testing
```javascript
// Test v·ªõi dataset l·ªõn
const testCases = [
  { keyword: '', expectedMethod: 'basic' },
  { keyword: 'Nguyen', expectedMethod: 'aggregation' },
  { keyword: 'HS001', expectedMethod: 'aggregation' },
  { keyword: 's·ªët cao', expectedMethod: 'aggregation' }
];

// Measure execution time
console.time('medical-event-search');
await medicalEventRepo.getAllMedicalEvents(query);
console.timeEnd('medical-event-search');
```

## üì¶ Migration Notes

### 1. Backward Compatibility
- API structure gi·ªØ nguy√™n 100%
- Response format kh√¥ng thay ƒë·ªïi (ch·ªâ b·ªõt fields nh·∫°y c·∫£m)
- Query parameters t∆∞∆°ng th√≠ch v·ªõi c≈©

### 2. Deployment Checklist
- [ ] Backup database tr∆∞·ªõc khi deploy
- [ ] Test aggregation pipeline tr√™n staging
- [ ] Verify indexes ƒë√£ ƒë∆∞·ª£c t·∫°o
- [ ] Test privacy - ƒë·∫£m b·∫£o kh√¥ng c√≥ password leak
- [ ] Monitor performance sau deploy

## üöÄ Future Enhancements

### 1. Full-text Search
- Implement MongoDB Atlas Search
- Support fuzzy search, synonyms
- Better ranking v√† relevance scoring

### 2. Advanced Filtering
- Date range v·ªõi better UX
- Multiple status selection
- Complex boolean operations

### 3. Audit Trail
- Log t·∫•t c·∫£ search queries
- Track user access patterns
- Security monitoring

### 4. Caching
- Redis cache cho popular searches
- Cache aggregation results
- TTL-based invalidation

### **Endpoint:** 
```
GET /api/medical-events/all?keyword={search_term}
```

### **V√≠ D·ª• S·ª≠ D·ª•ng:**

#### 1. T√¨m ki·∫øm theo t√™n h·ªçc sinh:
```bash
GET /api/medical-events/all?keyword=Nguy·ªÖn VƒÉn An
```

#### 2. T√¨m ki·∫øm theo m√£ s·ªë h·ªçc sinh:
```bash
GET /api/medical-events/all?keyword=SV001
```

#### 3. T√¨m ki·∫øm theo m√¥ t·∫£ s·ª± ki·ªán:
```bash
GET /api/medical-events/all?keyword=ng·∫•t x·ªâu
```

#### 4. K·∫øt h·ª£p v·ªõi c√°c filter kh√°c:
```bash
GET /api/medical-events/all?keyword=Nguy·ªÖn&type=c·∫•p c·ª©u&status=Ch·ªù x·ª≠ l√≠&level=3
```

#### 5. K·∫øt h·ª£p v·ªõi pagination:
```bash
GET /api/medical-events/all?keyword=An&page=1&limit=10&sort=dateHappened:desc
```

## ‚öôÔ∏è Implementation Details

### **Aggregation Pipeline Flow:**

1. **$unwind**: T√°ch array `studentJoin` th√†nh c√°c documents ri√™ng bi·ªát
2. **$lookup**: Join v·ªõi collection `children` ƒë·ªÉ l·∫•y th√¥ng tin h·ªçc sinh
3. **$match**: Apply base filters (type, level, status, dateHappened)  
4. **$match**: Apply keyword search v·ªõi $regex
5. **$group**: Gom nh√≥m l·∫°i theo medical event ID g·ªëc
6. **$lookup**: Join v·ªõi collection `users` ƒë·ªÉ l·∫•y th√¥ng tin y t√°
7. **$lookup**: Join l·∫°i v·ªõi `children` ƒë·ªÉ populate student data
8. **$sort**: S·∫Øp x·∫øp k·∫øt qu·∫£
9. **$skip + $limit**: Pagination

### **Performance Optimization:**

#### **Automatic Query Strategy:**
- **C√≥ keyword**: S·ª≠ d·ª•ng Aggregation Pipeline
- **Kh√¥ng c√≥ keyword**: S·ª≠ d·ª•ng find() query th√¥ng th∆∞·ªùng (nhanh h∆°n)

#### **Index Recommendations:**
```javascript
// Recommended indexes for better performance
db.children.createIndex({ "name": "text", "studentCode": "text" })
db.medicalevents.createIndex({ "type": 1, "status": 1, "dateHappened": -1 })
db.medicalevents.createIndex({ "studentJoin.studentId": 1 })
```

## üìä Sample Response

```json
{
  "statusCode": 200,
  "message": "Medical events retrieved successfully",
  "data": {
    "records": [
      {
        "_id": "60f7b3b3b3b3b3b3b3b3b3b3",
        "type": "c·∫•p c·ª©u",
        "status": "ƒê√£ x·ª≠ l√≠", 
        "level": 3,
        "description": "H·ªçc sinh ng·∫•t x·ªâu trong gi·ªù th·ªÉ d·ª•c",
        "dateHappened": "2025-06-28T10:30:00.000Z",
        "note": "ƒê√£ s∆° c·ª©u v√† li√™n h·ªá ph·ª• huynh",
        "solution": "Cho ngh·ªâ ng∆°i v√† u·ªëng n∆∞·ªõc",
        "userId": [
          {
            "_id": "60f7b3b3b3b3b3b3b3b3b3b3",
            "name": "Y t√° Ph·∫°m Th·ªã Lan",
            "email": "nurse.lan@school.edu.vn"
          }
        ],
        "studentJoin": [
          {
            "studentId": {
              "_id": "60f7b3b3b3b3b3b3b3b3b3b3",
              "name": "Nguy·ªÖn VƒÉn An",
              "studentCode": "SV001",
              "gender": "Nam",
              "birthdate": "2010-05-15T00:00:00.000Z"
            }
          }
        ],
        "createdAt": "2025-06-28T10:35:00.000Z",
        "updatedAt": "2025-06-28T11:00:00.000Z"
      }
    ],
    "totalPages": 1,
    "page": 1,
    "total": 1,
    "limit": 10
  }
}
```

## üîß Supported Query Parameters

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `keyword` | string | T√¨m ki·∫øm trong t√™n HS, m√£ HS, m√¥ t·∫£, ghi ch√∫ | `keyword=Nguy·ªÖn` |
| `type` | string | Lo·∫°i s·ª± ki·ªán | `type=c·∫•p c·ª©u` |
| `level` | number | M·ª©c ƒë·ªô nghi√™m tr·ªçng (1-5) | `level=3` |
| `status` | string | Tr·∫°ng th√°i x·ª≠ l√Ω | `status=Ch·ªù x·ª≠ l√≠` |
| `startDate` | date | T·ª´ ng√†y | `startDate=2025-06-01` |
| `endDate` | date | ƒê·∫øn ng√†y | `endDate=2025-06-30` |
| `page` | number | Trang hi·ªán t·∫°i | `page=1` |
| `limit` | number | S·ªë l∆∞·ª£ng m·ªói trang | `limit=10` |
| `sort` | string | S·∫Øp x·∫øp | `sort=dateHappened:desc` |

## üéØ Use Cases

### **1. T√¨m Ki·∫øm H·ªçc Sinh C·ª• Th·ªÉ**
Y t√° mu·ªën xem l·ªãch s·ª≠ y t·∫ø c·ªßa h·ªçc sinh "Nguy·ªÖn VƒÉn An":
```
GET /api/medical-events/all?keyword=Nguy·ªÖn VƒÉn An
```

### **2. T√¨m Theo M√£ S·ªë H·ªçc Sinh**
T√¨m t·∫•t c·∫£ s·ª± ki·ªán c·ªßa h·ªçc sinh c√≥ m√£ "SV001":
```
GET /api/medical-events/all?keyword=SV001
```

### **3. T√¨m Theo Lo·∫°i S·ª± Ki·ªán**
T√¨m t·∫•t c·∫£ tr∆∞·ªùng h·ª£p "ng·∫•t x·ªâu":
```
GET /api/medical-events/all?keyword=ng·∫•t x·ªâu
```

### **4. B√°o C√°o Th·ªëng K√™**
L·ªçc theo nhi·ªÅu ti√™u ch√≠ ƒë·ªÉ t·∫°o b√°o c√°o:
```
GET /api/medical-events/all?type=c·∫•p c·ª©u&level=4&status=ƒê√£ x·ª≠ l√≠&startDate=2025-06-01&endDate=2025-06-30
```

## ‚ö†Ô∏è L∆∞u √ù Quan Tr·ªçng

1. **Performance**: Aggregation pipeline c√≥ th·ªÉ ch·∫≠m h∆°n v·ªõi dataset l·ªõn
2. **Memory**: Pipeline s·ª≠ d·ª•ng nhi·ªÅu memory h∆°n v·ªõi complex lookups
3. **Indexing**: C·∫ßn t·∫°o index ph√π h·ª£p ƒë·ªÉ t·ªëi ∆∞u performance
4. **Regex**: T√¨m ki·∫øm regex c√≥ th·ªÉ ch·∫≠m v·ªõi text d√†i

## üîÑ Upgrade Path

N·∫øu c·∫ßn optimize th√™m, c√≥ th·ªÉ:
1. Implement full-text search v·ªõi MongoDB Atlas Search
2. S·ª≠ d·ª•ng Elasticsearch cho advanced search
3. Caching k·∫øt qu·∫£ t√¨m ki·∫øm ph·ªï bi·∫øn
4. Implement search suggestions/autocomplete

---

**K·∫øt qu·∫£**: Medical Event search gi·ªù ƒë√¢y h·ªó tr·ª£ t√¨m ki·∫øm th√¥ng minh theo t√™n v√† m√£ h·ªçc sinh, gi√∫p y t√° d·ªÖ d√†ng tra c·ª©u th√¥ng tin y t·∫ø h·ªçc sinh.

## üêõ Troubleshooting & Common Issues

### 1. **Filter kh√¥ng ho·∫°t ƒë·ªông v·ªõi keyword search**

**V·∫•n ƒë·ªÅ:** Khi s·ª≠ d·ª•ng keyword k·∫øt h·ª£p v·ªõi filters kh√°c (type, level, status, dateHappened), k·∫øt qu·∫£ kh√¥ng ƒë√∫ng.

**Nguy√™n nh√¢n:** 
- Base filters ƒë∆∞·ª£c √°p d·ª•ng sau khi unwind studentJoin, g√¢y ra duplicate records
- Date filter logic b·ªã ghi ƒë√® khi c√≥ c·∫£ startDate v√† endDate
- Level filter c√≥ th·ªÉ l√† string nh∆∞ng database l∆∞u l√† number

**Gi·∫£i ph√°p ƒë√£ √°p d·ª•ng:**

#### Fix 1: Th·ª© t·ª± Pipeline ƒë√∫ng
```typescript
const pipeline = [
  // ‚úÖ ƒê√öNG: Apply base filters TR∆Ø·ªöC khi unwind
  { $match: baseFilter },
  { $unwind: '$studentJoin' },
  // ... rest of pipeline
};

// ‚ùå SAI: Apply base filters SAU khi unwind
const wrongPipeline = [
  { $unwind: '$studentJoin' },
  { $match: baseFilter }, // ‚Üê Sai th·ª© t·ª±!
];
```

#### Fix 2: Date Filter Logic
```typescript
// ‚úÖ ƒê√öNG: Build date filter properly
const dateFilter: any = {};
if (this.startDate) {
  dateFilter.$gte = this.startDate;
}
if (this.endDate) {
  dateFilter.$lte = this.endDate;
}
if (Object.keys(dateFilter).length > 0) {
  filter.dateHappened = dateFilter;
}

// ‚ùå SAI: Date filter b·ªã ghi ƒë√®
if (this.startDate) {
  filter.dateHappened = { $gte: this.startDate };
}
if (this.endDate) {
  filter.dateHappened = { ...filter.dateHappened, $lte: this.endDate }; // C√≥ th·ªÉ undefined
}
```

#### Fix 3: Level Type Conversion
```typescript
// ‚úÖ ƒê√öNG: Convert string to number
if (this.rawQuery?.level) {
  filter.level = typeof this.rawQuery.level === 'string' 
    ? parseInt(this.rawQuery.level, 10) 
    : this.rawQuery.level;
}

// ‚ùå SAI: Kh√¥ng convert type
filter.level = this.rawQuery.level; // C√≥ th·ªÉ l√† string
```

### 2. **Performance Issues v·ªõi Aggregation**

**V·∫•n ƒë·ªÅ:** Query ch·∫≠m v·ªõi dataset l·ªõn.

**Gi·∫£i ph√°p:**
- T·∫°o indexes ph√π h·ª£p
- S·ª≠ d·ª•ng `allowDiskUse: true` n·∫øu c·∫ßn
- Monitor memory usage

```javascript
// Recommended indexes
db.medicalevents.createIndex({ "type": 1, "level": 1, "status": 1 });
db.medicalevents.createIndex({ "dateHappened": -1 });
db.children.createIndex({ "name": "text", "studentCode": "text" });
```

### 3. **Debug Aggregation Pipeline**

ƒê·ªÉ debug pipeline, th√™m logging:

```typescript
console.log('Base Filter:', JSON.stringify(baseFilter, null, 2));
console.log('Pipeline:', JSON.stringify(pipeline, null, 2));

// Test t·ª´ng stage ri√™ng bi·ªát
const stage1Result = await this.model.aggregate([
  { $match: baseFilter }
]).exec();
console.log('After base filter:', stage1Result.length);
```
